#cloud-config
autoinstall:
  version: 1
  kind: block-device

  # Mandatory Installation Sections
  timezone: America/New_York

  identity:
    hostname: ubuntu-template
    username: ubuntu
    password: "$6$WwS4E5hx$Q7hA5b2N4GX42ZcBfxtlYMaORuxxg.kJHdYz7VxhRjGUCPbVmpxrx5MfUKpCmB8NWVEjHgCeyfVg5jZWh/4Q/"

  storage:
    config:
      - ptable: gpt
        path: /dev/sda
        wipe: superblock-recursive
        preserve: false
        name: disk0
        grub_device: true
        type: disk
        devices: [all]
      - device: disk0
        size: 1G
        type: partition
        id: partition-0
      - device: disk0
        size: 100%
        type: partition
        id: partition-1
      - fstype: ext4
        id: fs-0
        partition: partition-1
        type: format
      - mountpoint: /
        type: mount
        device: fs-0

  locale: en_US.UTF-8
  keyboard:
    layout: us
    variant: ""

  network:
    version: 2
    ethernets:
      enp4s0:
        dhcp4: true
        optional: true

  ssh:
    install-server: true
    allow-pw: false
    authorized-keys:
      - "${ssh_pub_key}"

  packages:
    - qemu-guest-agent
    - openssh-server

  late-commands:
    - curtin in-target -- systemctl enable --now qemu-guest-agent
